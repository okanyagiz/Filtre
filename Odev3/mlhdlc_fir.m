%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% MATLAB design: FIR Filter
% 
% Key Design pattern covered in this example: 
% (1) Implementation of a tap delay using a an array of persistent variables
% (2) Filter coefficients as a constant array
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%   Copyright 2011-2015 The MathWorks, Inc.

function outdatabuf=mlhdlc_fir(indatabuf)

% Load the filter coefficients
coeff = [-5667330300805407/10384593717069655257060992658440192, -6241210546413319/(36893488147419103232*1), -2730528454882471/(9223372036854775808*1^2), -1581035513385233/(4611686018427387904*1^3), -5354377953800399/(18446744073709551616*1^4), -5323298070969679/(36893488147419103232*1^5), 575395407791675/(9223372036854775808*1^6), 5081278061276111/(18446744073709551616*1^7), 3975546828814627/(9223372036854775808*1^8), 4359838792831393/(9223372036854775808*1^9), 6822018030682785/(18446744073709551616*1^10), 4857352071505369/(36893488147419103232*1^11), -6945029326701297/(36893488147419103232*1^12), -1154984623968587/(2305843009213693952*1^13), -1623258745251121/(2305843009213693952*1^14), -3286688303961631/(4611686018427387904*1^15), -4525906297046677/(9223372036854775808*1^16), -5228641595035313/(73786976294838206464*1^17), 2044587555702957/(4611686018427387904*1^18), 8298163152392327/(9223372036854775808*1^19), 5253552943950099/(4611686018427387904*1^20), 4831535544571073/(4611686018427387904*1^21), 5544124369376547/(9223372036854775808*1^22), -8251017619087309/(73786976294838206464*1^23), -8308462384665133/(9223372036854775808*1^24), -7013739994142125/(4611686018427387904*1^25), -8045467126114433/(4611686018427387904*1^26), -829894498126455/(576460752303423488*1^27), -2888899833960985/(4611686018427387904*1^28), 4668801374869851/(9223372036854775808*1^29), 7555882923021523/(4611686018427387904*1^30), 5546211750428459/(2305843009213693952*1^31), 5785843680565315/(2305843009213693952*1^32), 8420701455837865/(4611686018427387904*1^33), 4319327859859065/(9223372036854775808*1^34), -5620809662923691/(4611686018427387904*1^35), -6316375453566443/(2305843009213693952*1^36), -8268881468216325/(2305843009213693952*1^37), -490392060504919/(144115188075855872*1^38), -4882048532850379/(2305843009213693952*1^39), 4781809941304561/(1298074214633706907132624082305024*1^40), 5487580132505189/(2305843009213693952*1^41), 2478611088006357/(576460752303423488*1^42), 2937060355986893/(576460752303423488*1^43), 9857300183199/(2251799813685248*1^44), 1263437709943595/(576460752303423488*1^45), -4372460817175133/(4611686018427387904*1^46), -4801890489455559/(1152921504606846976*1^47), -7440201684175379/(1152921504606846976*1^48), -8048773552767929/(1152921504606846976*1^49), -6193661825354541/(1152921504606846976*1^50), -8656737220754877/(4611686018427387904*1^51), 6065836438725575/(2305843009213693952*1^52), 3952119469621311/(576460752303423488*1^53), 2719728311639081/(288230376151711744*1^54), 5394726194937469/(576460752303423488*1^55), 3641804942310975/(576460752303423488*1^56), 2065071724249515/(2305843009213693952*1^57), -6351911903880627/(1152921504606846976*1^58), -3174698839113271/(288230376151711744*1^59), -7938548094595467/(576460752303423488*1^60), -1807015511387805/(144115188075855872*1^61), -8235880913886547/(1152921504606846976*1^62), 6105869017824995/(4611686018427387904*1^63), 1537176746462573/(144115188075855872*1^64), 2606387914391261/(144115188075855872*1^65), 3016946535890377/(144115188075855872*1^66), 2525877723634685/(144115188075855872*1^67), 8976601722034235/(1152921504606846976*1^68), -3729604009594749/(576460752303423488*1^69), -6260301560354195/(288230376151711744*1^70), -4815286093540615/(144115188075855872*1^71), -1332682737374407/(36028797018963968*1^72), -4182541019706355/(144115188075855872*1^73), -4723303718175401/(576460752303423488*1^74), 1739978356876357/(72057594037927936*1^75), 288297579760385/(4503599627370496*1^76), 7597676755771153/(72057594037927936*1^77), 1275482510089969/(9007199254740992*1^78), 374378552677395/(2251799813685248*1^79), 7/(40*1^80), 374378552677395/(2251799813685248*1^81), 1275482510089969/(9007199254740992*1^82), 7597676755771153/(72057594037927936*1^83), 288297579760385/(4503599627370496*1^84), 1739978356876357/(72057594037927936*1^85), -4723303718175401/(576460752303423488*1^86), -4182541019706355/(144115188075855872*1^87), -1332682737374407/(36028797018963968*1^88), -4815286093540615/(144115188075855872*1^89), -6260301560354195/(288230376151711744*1^90), -3729604009594749/(576460752303423488*1^91), 8976601722034235/(1152921504606846976*1^92), 2525877723634685/(144115188075855872*1^93), 3016946535890377/(144115188075855872*1^94), 2606387914391261/(144115188075855872*1^95), 1537176746462573/(144115188075855872*1^96), 6105869017824995/(4611686018427387904*1^97), -8235880913886547/(1152921504606846976*1^98), -1807015511387805/(144115188075855872*1^99), -7938548094595467/(576460752303423488*1^100), -3174698839113271/(288230376151711744*1^101), -6351911903880627/(1152921504606846976*1^102), 2065071724249515/(2305843009213693952*1^103), 3641804942310975/(576460752303423488*1^104), 5394726194937469/(576460752303423488*1^105), 2719728311639081/(288230376151711744*1^106), 3952119469621311/(576460752303423488*1^107), 6065836438725575/(2305843009213693952*1^108), -8656737220754877/(4611686018427387904*1^109), -6193661825354541/(1152921504606846976*1^110), -8048773552767929/(1152921504606846976*1^111), -7440201684175379/(1152921504606846976*1^112), -4801890489455559/(1152921504606846976*1^113), -4372460817175133/(4611686018427387904*1^114), 1263437709943595/(576460752303423488*1^115), 9857300183199/(2251799813685248*1^116), 2937060355986893/(576460752303423488*1^117), 2478611088006357/(576460752303423488*1^118), 5487580132505189/(2305843009213693952*1^119), 4781809941304561/(1298074214633706907132624082305024*1^120), -4882048532850379/(2305843009213693952*1^121), -490392060504919/(144115188075855872*1^122), -8268881468216325/(2305843009213693952*1^123), -6316375453566443/(2305843009213693952*1^124), -5620809662923691/(4611686018427387904*1^125), 4319327859859065/(9223372036854775808*1^126), 8420701455837865/(4611686018427387904*1^127), 5785843680565315/(2305843009213693952*1^128), 5546211750428459/(2305843009213693952*1^129), 7555882923021523/(4611686018427387904*1^130), 4668801374869851/(9223372036854775808*1^131), -2888899833960985/(4611686018427387904*1^132), -829894498126455/(576460752303423488*1^133), -8045467126114433/(4611686018427387904*1^134), -7013739994142125/(4611686018427387904*1^135), -8308462384665133/(9223372036854775808*1^136), -8251017619087309/(73786976294838206464*1^137), 5544124369376547/(9223372036854775808*1^138), 4831535544571073/(4611686018427387904*1^139), 5253552943950099/(4611686018427387904*1^140), 8298163152392327/(9223372036854775808*1^141), 2044587555702957/(4611686018427387904*1^142), -5228641595035313/(73786976294838206464*1^143), -4525906297046677/(9223372036854775808*1^144), -3286688303961631/(4611686018427387904*1^145), -1623258745251121/(2305843009213693952*1^146), -1154984623968587/(2305843009213693952*1^147), -6945029326701297/(36893488147419103232*1^148), 4857352071505369/(36893488147419103232*1^149), 6822018030682785/(18446744073709551616*1^150), 4359838792831393/(9223372036854775808*1^151), 3975546828814627/(9223372036854775808*1^152), 5081278061276111/(18446744073709551616*1^153), 575395407791675/(9223372036854775808*1^154), -5323298070969679/(36893488147419103232*1^155), -5354377953800399/(18446744073709551616*1^156), -1581035513385233/(4611686018427387904*1^157), -2730528454882471/(9223372036854775808*1^158), -6241210546413319/(36893488147419103232*1^159), -5667330300805407/(10384593717069655257060992658440192*1^160)];

persistent tap_delay;

% Clear tap delay line at beginning
if isempty(tap_delay)
  tap_delay = zeros(1,length(coeff));
end

% Perform sum of products
outdatabuf = tap_delay * coeff(end:-1:1)';

% Shift tap delay line
tap_delay = [tap_delay(2:length(coeff)) indatabuf];
